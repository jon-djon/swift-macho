//
//  LC_UNIXTHREAD.swift
//  swift-macho
//
//  Created by jon on 11/2/25.
//

import Foundation
import Testing
import BinaryParsing
@testable import SwiftMachO

struct LC_UNIXTHREAD_Tests {
    // LC_UNIXTHREAD with x86_64 thread state
    // Header: cmd=0x05 (5), cmdsize=0xB8 (184)
    // flavor=0x04 (x86_THREAD_STATE64), count=0x2A (42)
    let dataX86_64 = Data([
        0x05, 0x00, 0x00, 0x00,  // cmd = LC_UNIXTHREAD (0x05)
        0xB8, 0x00, 0x00, 0x00,  // cmdsize = 184
        0x04, 0x00, 0x00, 0x00,  // flavor = x86_THREAD_STATE64 (4)
        0x2A, 0x00, 0x00, 0x00,  // count = 42
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rax
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rbx
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rcx
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rdx
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rdi
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rsi
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rbp
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rsp
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r8
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r9
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r10
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r11
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r12
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r13
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r14
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // r15
        0x50, 0x4E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rip = 0x4E50
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // rflags
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // cs
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // fs
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // gs
    ])
    
    // LC_UNIXTHREAD with ARM64 thread state
    // Header: cmd=0x05 (5), cmdsize=0x120 (288)
    // flavor=0x06 (ARM_THREAD_STATE64), count=0x44 (68)
    let dataARM64 = Data([
        0x05, 0x00, 0x00, 0x00,  // cmd = LC_UNIXTHREAD (0x05)
        0x20, 0x01, 0x00, 0x00,  // cmdsize = 288
        0xEE, 0x03, 0x00, 0x00,  // flavor = ARM_THREAD_STATE64 (1006)
        0x44, 0x00, 0x00, 0x00,  // count = 68
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x0
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x1
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x2
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x3
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x4
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x5
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x6
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x7
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x8
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x9
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x10
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x11
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x12
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x13
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x14
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x15
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x16
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x17
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x18
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x19
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x20
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x21
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x22
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x23
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x24
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x25
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x26
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x27
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // x28
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // fp (x29)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // lr (x30)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // sp
        0xC0, 0x49, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // pc = 0x49C0
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // cpsr
    ])

    // Wrong command ID
    let bad = Data([0x32, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00])
    
    @Test
    func LC_UNIXTHREAD_X86_64() throws {
        try dataX86_64.withParserSpan { span in
            let f = try SwiftMachO.LC_UNIXTHREAD(parsing: &span, endianness: .little)
            #expect(f.header.id == .LC_UNIXTHREAD)
            #expect(f.header.cmdSize == 184)
            #expect(f.range == 0..<Int(f.header.cmdSize))
            #expect(f.flavor == .x86_THREAD_STATE64)
            #expect(span.count == 0)
        }
    }
    
    @Test
    func LC_UNIXTHREAD_ARM64() throws {
        try dataARM64.withParserSpan { span in
            let f = try SwiftMachO.LC_UNIXTHREAD(parsing: &span, endianness: .little)
            #expect(f.header.id == .LC_UNIXTHREAD)
            #expect(f.header.cmdSize == 288)
            #expect(f.range == 0..<Int(f.header.cmdSize))
            #expect(f.flavor == .ARM_THREAD_STATE64)
            #expect(span.count == 0)
        }
    }
    
    @Test
    func LC_UNIXTHREAD_InvalidCommand() throws {
        _ = bad.withParserSpan { span in
            #expect(throws: SwiftMachO.MachOError.self) {
                _ = try SwiftMachO.LC_UNIXTHREAD(parsing: &span, endianness: .little)
            }
        }
    }
}
